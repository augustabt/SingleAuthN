<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>SingleAuthN</title>
  </head>

  <body>
    <h1>SingleAuthN Authenticator Registration</h1>
    <br>
    <button onclick="registerUser()">Register New Authenticator</button>

    <script>
      function bufferDecode(value) {
      return Uint8Array.from(atob(value), c => c.charCodeAt(0));
      }

      function bufferEncode(value) {
      return btoa(String.fromCharCode.apply(null, new Uint8Array(value)))
        .replace(/\+/g, "-")
        .replace(/\//g, "_")
        .replace(/=/g, "");;
    }


      function registerUser() {
        fetch('http://localhost:7633/registration/begin').then((response) => response.json()).then((data) => {
          data.publicKey.challenge = bufferDecode(data.publicKey.challenge)
          data.publicKey.user.id = bufferDecode(data.publicKey.user.id)
          if (data.publicKey.excludeCredentials) {
            for (var i = 0; i < data.publicKey.excludeCredentials.length; i++) {
              data.publicKey.excludeCredentials[i].id = bufferDecode(data.publicKey.excludeCredentials[i].id);
            }
          }

          navigator.credentials.create({
            publicKey: data.publicKey
          }).then((credential) => {
            let attestationObject = credential.response.attestationObject;
            let clientDataJSON = credential.response.clientDataJSON;
            let rawId = credential.rawId;

            fetch('http://localhost:7633/registration/finish', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json'
              },
              body: JSON.stringify({
                id: credential.id,
                rawId: bufferEncode(rawId),
                type: credential.type,
                response: {
                  attestationObject: bufferEncode(attestationObject),
                  clientDataJSON: bufferEncode(clientDataJSON),
                },
              })
            })
          })
        })
      }
    </script>
  </body>
</html>